package dev.aikido.agent_api.vulnerabilities;

import dev.aikido.agent_api.background.Endpoint;
import dev.aikido.agent_api.background.ServiceConfiguration;
import dev.aikido.agent_api.context.ContextObject;
import dev.aikido.agent_api.storage.ConfigStore;

import java.util.List;

import static dev.aikido.agent_api.helpers.patterns.MatchEndpoints.matchEndpoints;

public final class SkipVulnerabilityScanDecider {
    private SkipVulnerabilityScanDecider() {}
    public static boolean shouldSkipVulnerabilityScan(ContextObject context) {
        if (context == null) {
            return true;
        }
        ServiceConfiguration config = ConfigStore.getServiceConfig();
        if (config != null) {
            if (config.isBypassedIP(context.getRemoteAddress())) {
                return true; // Bypassed IP Addresses are not subject to vulnerability scans
            }
            List<Endpoint> matchedEndpoints = matchEndpoints(context.getRouteMetadata(), config.getEndpoints());
            if (matchedEndpoints != null && !matchedEndpoints.isEmpty()) {
                return matchedEndpoints.get(0).protectionForcedOff();
            }
        }
        return false;
    }
}
